{"version":3,"file":"image_utils.js","names":["child_process","fs","activeWindow","PNG","waitMS","ms","Promise","resolve","setTimeout","readPng","filename","data","readFileSync","sync","read","writePng","width","height","png","colorType","i","byteLength","buffer","write","writeFileSync","ScreenshotManager","init","page","title","evaluate","Math","random","document","window","windows","getOpenWindows","screenRecordingPermission","find","includes","Error","takeScreenshot","screenshotName","history","replaceState","spawnSync","id"],"sources":["../../../src/common/tools/image_utils.ts"],"sourcesContent":["import * as child_process from 'child_process';\nimport * as fs from 'fs';\n\nimport * as activeWindow from 'active-win';\nimport { Page } from 'playwright-core';\nimport { PNG } from 'pngjs';\n\n// eslint-disable-next-line ban/ban\nconst waitMS = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));\n\nexport function readPng(filename: string) {\n  const data = fs.readFileSync(filename);\n  return PNG.sync.read(data);\n}\n\nexport function writePng(filename: string, width: number, height: number, data: Buffer) {\n  const png = new PNG({ colorType: 6, width, height });\n  for (let i = 0; i < data.byteLength; ++i) {\n    png.data[i] = data[i];\n  }\n  const buffer = PNG.sync.write(png);\n  fs.writeFileSync(filename, buffer);\n}\n\nexport class ScreenshotManager {\n  window?: activeWindow.Result;\n\n  async init(page: Page) {\n    // set the title to some random number so we can find the window by title\n    const title: string = await page.evaluate(() => {\n      const title = `t-${Math.random()}`;\n      document.title = title;\n      return title;\n    });\n\n    // wait for the window to show up\n    let window;\n    for (let i = 0; !window && i < 100; ++i) {\n      await waitMS(50);\n      const windows = await activeWindow.getOpenWindows({ screenRecordingPermission: true });\n      window = windows.find(window => window.title.includes(title));\n    }\n    if (!window) {\n      throw Error(`could not find window: ${title}`);\n    }\n    this.window = window;\n  }\n\n  async takeScreenshot(page: Page, screenshotName: string) {\n    // await page.screenshot({ path: screenshotName });\n\n    // we need to set the url and title since the screenshot will include the chrome\n    await page.evaluate(async () => {\n      document.title = 'screenshot';\n      window.history.replaceState({}, '', '/screenshot');\n    });\n    child_process.spawnSync('screencapture', ['-o', '-x', `-l${this.window!.id}`, screenshotName]);\n  }\n}\n"],"mappings":";AAAA;AAAA,GAAA,OAAO,KAAKA,aAAa,MAAM,eAAe,CAC9C,OAAO,KAAKC,EAAE,MAAM,IAAI;AAExB,OAAO,KAAKC,YAAY,MAAM,YAAY;;AAE1C,SAASC,GAAG,QAAQ,OAAO;;;AAG3B,MAAMC,MAAM,GAAG,CAACC,EAAU,KAAK,IAAIC,OAAO,CAAC,CAAAC,OAAO,KAAIC,UAAU,CAACD,OAAO,EAAEF,EAAE,CAAC,CAAC;;AAE9E,OAAO,SAASI,OAAO,CAACC,QAAgB,EAAE;EACxC,MAAMC,IAAI,GAAGV,EAAE,CAACW,YAAY,CAACF,QAAQ,CAAC;EACtC,OAAOP,GAAG,CAACU,IAAI,CAACC,IAAI,CAACH,IAAI,CAAC;AAC5B;;AAEA,OAAO,SAASI,QAAQ,CAACL,QAAgB,EAAEM,KAAa,EAAEC,MAAc,EAAEN,IAAY,EAAE;EACtF,MAAMO,GAAG,GAAG,IAAIf,GAAG,CAAC,EAAEgB,SAAS,EAAE,CAAC,EAAEH,KAAK,EAAEC,MAAM,CAAC,CAAC,CAAC;EACpD,KAAK,IAAIG,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGT,IAAI,CAACU,UAAU,EAAE,EAAED,CAAC,EAAE;IACxCF,GAAG,CAACP,IAAI,CAACS,CAAC,CAAC,GAAGT,IAAI,CAACS,CAAC,CAAC;EACvB;EACA,MAAME,MAAM,GAAGnB,GAAG,CAACU,IAAI,CAACU,KAAK,CAACL,GAAG,CAAC;EAClCjB,EAAE,CAACuB,aAAa,CAACd,QAAQ,EAAEY,MAAM,CAAC;AACpC;;AAEA,OAAO,MAAMG,iBAAiB,CAAC;;;EAG7B,MAAMC,IAAI,CAACC,IAAU,EAAE;IACrB;IACA,MAAMC,KAAa,GAAG,MAAMD,IAAI,CAACE,QAAQ,CAAC,MAAM;MAC9C,MAAMD,KAAK,GAAI,KAAIE,IAAI,CAACC,MAAM,EAAG,EAAC;MAClCC,QAAQ,CAACJ,KAAK,GAAGA,KAAK;MACtB,OAAOA,KAAK;IACd,CAAC,CAAC;;IAEF;IACA,IAAIK,MAAM;IACV,KAAK,IAAIb,CAAC,GAAG,CAAC,EAAE,CAACa,MAAM,IAAIb,CAAC,GAAG,GAAG,EAAE,EAAEA,CAAC,EAAE;MACvC,MAAMhB,MAAM,CAAC,EAAE,CAAC;MAChB,MAAM8B,OAAO,GAAG,MAAMhC,YAAY,CAACiC,cAAc,CAAC,EAAEC,yBAAyB,EAAE,IAAI,CAAC,CAAC,CAAC;MACtFH,MAAM,GAAGC,OAAO,CAACG,IAAI,CAAC,CAAAJ,MAAM,KAAIA,MAAM,CAACL,KAAK,CAACU,QAAQ,CAACV,KAAK,CAAC,CAAC;IAC/D;IACA,IAAI,CAACK,MAAM,EAAE;MACX,MAAMM,KAAK,CAAE,0BAAyBX,KAAM,EAAC,CAAC;IAChD;IACA,IAAI,CAACK,MAAM,GAAGA,MAAM;EACtB;;EAEA,MAAMO,cAAc,CAACb,IAAU,EAAEc,cAAsB,EAAE;IACvD;;IAEA;IACA,MAAMd,IAAI,CAACE,QAAQ,CAAC,YAAY;MAC9BG,QAAQ,CAACJ,KAAK,GAAG,YAAY;MAC7BK,MAAM,CAACS,OAAO,CAACC,YAAY,CAAC,CAAC,CAAC,EAAE,EAAE,EAAE,aAAa,CAAC;IACpD,CAAC,CAAC;IACF3C,aAAa,CAAC4C,SAAS,CAAC,eAAe,EAAE,CAAC,IAAI,EAAE,IAAI,EAAG,KAAI,IAAI,CAACX,MAAM,CAAEY,EAAG,EAAC,EAAEJ,cAAc,CAAC,CAAC;EAChG;AACF"}