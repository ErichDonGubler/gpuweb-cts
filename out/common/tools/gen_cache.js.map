{"version":3,"sources":["../../../src/common/tools/gen_cache.ts"],"names":["fs","path","process","dataCache","setIsBuildingDataCache","usage","rc","console","error","exit","mode","nonFlagsArgs","a","argv","startsWith","log","push","length","outRootDir","setStore","load","Promise","resolve","reject","readFile","err","data","message","suiteDir","slice","build","specFileSuffix","__filename","endsWith","crawlFilesRecursively","dir","subpathInfo","all","promises","readdir","map","d","p","join","stats","stat","isDirectory","isFile","files","filter","i","concat","reduce","b","existsSync","filesToEnumerate","sort","cacheablePathToTS","Map","file","pathWithoutExtension","substring","mod","serialize","undefined","cacheable","existing","get","set","outPath","serialized","mkdirSync","dirname","recursive","writeFileSync"],"mappings":"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","sourcesContent":["import * as fs from 'fs';\nimport * as path from 'path';\nimport * as process from 'process';\n\nimport { Cacheable, dataCache, setIsBuildingDataCache } from '../framework/data_cache.js';\n\nfunction usage(rc: number): void {\n  console.error(`Usage: tools/gen_cache [options] [OUT_DIR] [SUITE_DIRS...]\n\nFor each suite in SUITE_DIRS, pre-compute data that is expensive to generate\nat runtime and store it under OUT_DIR. If the data file is found then the\nDataCache will load this instead of building the expensive data at CTS runtime.\n\nOptions:\n  --help          Print this message and exit.\n  --list          Print the list of output files without writing them.\n`);\n  process.exit(rc);\n}\n\nlet mode: 'emit' | 'list' = 'emit';\n\nconst nonFlagsArgs: string[] = [];\nfor (const a of process.argv) {\n  if (a.startsWith('-')) {\n    if (a === '--list') {\n      mode = 'list';\n    } else if (a === '--help') {\n      usage(0);\n    } else {\n      console.log('unrecognized flag: ', a);\n      usage(1);\n    }\n  } else {\n    nonFlagsArgs.push(a);\n  }\n}\n\nif (nonFlagsArgs.length < 4) {\n  usage(0);\n}\n\nconst outRootDir = nonFlagsArgs[2];\n\ndataCache.setStore({\n  load: (path: string) => {\n    return new Promise<string>((resolve, reject) => {\n      fs.readFile(`data/${path}`, 'utf8', (err, data) => {\n        if (err !== null) {\n          reject(err.message);\n        } else {\n          resolve(data);\n        }\n      });\n    });\n  },\n});\nsetIsBuildingDataCache();\n\nvoid (async () => {\n  for (const suiteDir of nonFlagsArgs.slice(3)) {\n    await build(suiteDir);\n  }\n})();\n\nconst specFileSuffix = __filename.endsWith('.ts') ? '.spec.ts' : '.spec.js';\n\nasync function crawlFilesRecursively(dir: string): Promise<string[]> {\n  const subpathInfo = await Promise.all(\n    (await fs.promises.readdir(dir)).map(async d => {\n      const p = path.join(dir, d);\n      const stats = await fs.promises.stat(p);\n      return {\n        path: p,\n        isDirectory: stats.isDirectory(),\n        isFile: stats.isFile(),\n      };\n    })\n  );\n\n  const files = subpathInfo\n    .filter(i => i.isFile && i.path.endsWith(specFileSuffix))\n    .map(i => i.path);\n\n  return files.concat(\n    await subpathInfo\n      .filter(i => i.isDirectory)\n      .map(i => crawlFilesRecursively(i.path))\n      .reduce(async (a, b) => (await a).concat(await b), Promise.resolve([]))\n  );\n}\n\nasync function build(suiteDir: string) {\n  if (!fs.existsSync(suiteDir)) {\n    console.error(`Could not find ${suiteDir}`);\n    process.exit(1);\n  }\n\n  // Crawl files and convert paths to be POSIX-style, relative to suiteDir.\n  const filesToEnumerate = (await crawlFilesRecursively(suiteDir)).sort();\n\n  const cacheablePathToTS = new Map<string, string>();\n\n  for (const file of filesToEnumerate) {\n    if (file.endsWith(specFileSuffix)) {\n      const pathWithoutExtension = file.substring(0, file.length - specFileSuffix.length);\n      const mod = await import(`../../../${pathWithoutExtension}.spec.js`);\n      if (mod.d?.serialize !== undefined) {\n        const cacheable = mod.d as Cacheable<unknown>;\n\n        {\n          // Check for collisions\n          const existing = cacheablePathToTS.get(cacheable.path);\n          if (existing !== undefined) {\n            console.error(\n              `error: Cacheable '${cacheable.path}' is emitted by both:\n    '${existing}'\nand\n    '${file}'`\n            );\n            process.exit(1);\n          }\n          cacheablePathToTS.set(cacheable.path, file);\n        }\n\n        const outPath = `${outRootDir}/data/${cacheable.path}`;\n\n        switch (mode) {\n          case 'emit': {\n            const data = await cacheable.build();\n            const serialized = cacheable.serialize(data);\n            fs.mkdirSync(path.dirname(outPath), { recursive: true });\n            fs.writeFileSync(outPath, serialized);\n            break;\n          }\n          case 'list': {\n            console.log(outPath);\n            break;\n          }\n        }\n      }\n    }\n  }\n}\n"],"file":"gen_cache.js"}