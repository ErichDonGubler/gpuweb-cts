{"version":3,"sources":["../../../src/common/tools/checklist.ts"],"names":["fs","process","DefaultTestFileLoader","Ordering","compareQueries","parseQuery","TestQueryMultiFile","loadTreeForQuery","StacklessError","assert","usage","rc","console","error","exit","argv","length","loadQueryListFromTextFile","filename","lines","promises","readFile","split","allQueries","filter","l","map","trim","queriesBySuite","Map","query","suiteQueries","get","suite","undefined","set","push","checkForOverlappingQueries","queries","i1","i2","q1","q2","Unordered","log","checkForUnmatchedSubtrees","tree","matchQueries","subtreeCount","unmatchedSubtrees","overbroadMatches","alwaysExpandThroughLevel","collapsedSubtree","iterateCollapsedQueries","subtreeMatched","q","comparison","StrictSubset","StrictSuperset","join","Array","from","keys","loader","queriesInSuite","entries","suiteQuery","catch","ex","stack","toString"],"mappings":"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","sourcesContent":["import * as fs from 'fs';\nimport * as process from 'process';\n\nimport { DefaultTestFileLoader } from '../internal/file_loader.js';\nimport { Ordering, compareQueries } from '../internal/query/compare.js';\nimport { parseQuery } from '../internal/query/parseQuery.js';\nimport { TestQuery, TestQueryMultiFile } from '../internal/query/query.js';\nimport { loadTreeForQuery, TestTree } from '../internal/tree.js';\nimport { StacklessError } from '../internal/util.js';\nimport { assert } from '../util/util.js';\n\nfunction usage(rc: number): void {\n  console.error('Usage:');\n  console.error('  tools/checklist FILE');\n  console.error('  tools/checklist my/list.txt');\n  process.exit(rc);\n}\n\nif (process.argv.length === 2) usage(0);\nif (process.argv.length !== 3) usage(1);\n\ntype QueriesBySuite = Map<string, TestQuery[]>;\nasync function loadQueryListFromTextFile(filename: string): Promise<QueriesBySuite> {\n  const lines = (await fs.promises.readFile(filename, 'utf8')).split(/\\r?\\n/);\n  const allQueries = lines.filter(l => l).map(l => parseQuery(l.trim()));\n\n  const queriesBySuite: QueriesBySuite = new Map();\n  for (const query of allQueries) {\n    let suiteQueries = queriesBySuite.get(query.suite);\n    if (suiteQueries === undefined) {\n      suiteQueries = [];\n      queriesBySuite.set(query.suite, suiteQueries);\n    }\n\n    suiteQueries.push(query);\n  }\n\n  return queriesBySuite;\n}\n\nfunction checkForOverlappingQueries(queries: TestQuery[]): void {\n  for (let i1 = 0; i1 < queries.length; ++i1) {\n    for (let i2 = i1 + 1; i2 < queries.length; ++i2) {\n      const q1 = queries[i1];\n      const q2 = queries[i2];\n      if (compareQueries(q1, q2) !== Ordering.Unordered) {\n        console.log(`    FYI, the following checklist items overlap:\\n      ${q1}\\n      ${q2}`);\n      }\n    }\n  }\n}\n\nfunction checkForUnmatchedSubtrees(tree: TestTree, matchQueries: TestQuery[]): number {\n  let subtreeCount = 0;\n  const unmatchedSubtrees: TestQuery[] = [];\n  const overbroadMatches: [TestQuery, TestQuery][] = [];\n  const alwaysExpandThroughLevel = 1; // expand to, at minimum, every file.\n  for (const collapsedSubtree of tree.iterateCollapsedQueries(true, alwaysExpandThroughLevel)) {\n    subtreeCount++;\n    let subtreeMatched = false;\n    for (const q of matchQueries) {\n      const comparison = compareQueries(q, collapsedSubtree);\n      assert(comparison !== Ordering.StrictSubset); // shouldn't happen, due to subqueriesToExpand\n      if (comparison === Ordering.StrictSuperset) overbroadMatches.push([q, collapsedSubtree]);\n      if (comparison !== Ordering.Unordered) subtreeMatched = true;\n    }\n    if (!subtreeMatched) unmatchedSubtrees.push(collapsedSubtree);\n  }\n\n  if (overbroadMatches.length) {\n    // (note, this doesn't show ALL multi-test queries - just ones that actually match any .spec.ts)\n    console.log(`  FYI, the following checklist items were broader than one file:`);\n    for (const [q, collapsedSubtree] of overbroadMatches) {\n      console.log(`    ${q}  >  ${collapsedSubtree}`);\n    }\n  }\n\n  if (unmatchedSubtrees.length) {\n    throw new StacklessError(`Found unmatched tests:\\n    ${unmatchedSubtrees.join('\\n    ')}`);\n  }\n  return subtreeCount;\n}\n\n(async () => {\n  console.log('Loading queries...');\n  const queriesBySuite = await loadQueryListFromTextFile(process.argv[2]);\n  console.log('  Found suites: ' + Array.from(queriesBySuite.keys()).join(' '));\n\n  const loader = new DefaultTestFileLoader();\n  for (const [suite, queriesInSuite] of queriesBySuite.entries()) {\n    console.log(`Suite \"${suite}\":`);\n    console.log(`  Checking overlaps between ${queriesInSuite.length} checklist items...`);\n    checkForOverlappingQueries(queriesInSuite);\n    const suiteQuery = new TestQueryMultiFile(suite, []);\n    console.log(`  Loading tree ${suiteQuery}...`);\n    const tree = await loadTreeForQuery(loader, suiteQuery, queriesInSuite);\n    console.log('  Found no invalid queries in the checklist. Checking for unmatched tests...');\n    const subtreeCount = checkForUnmatchedSubtrees(tree, queriesInSuite);\n    console.log(`  No unmatched tests among ${subtreeCount} subtrees!`);\n  }\n  console.log(`Checklist looks good!`);\n})().catch(ex => {\n  console.log(ex.stack ?? ex.toString());\n  process.exit(1);\n});\n"],"file":"checklist.js"}