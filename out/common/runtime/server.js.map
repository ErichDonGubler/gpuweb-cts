{"version":3,"sources":["../../../src/common/runtime/server.ts"],"names":["fs","http","dataCache","DefaultTestFileLoader","prettyPrintLog","Logger","parseQuery","Colors","setGPUProvider","sys","usage","rc","console","log","type","exit","existsSync","enabled","verbose","gpuProviderModule","undefined","dataPath","gpuProviderFlags","i","args","length","a","startsWith","modulePath","require","push","create","setStore","load","path","Promise","resolve","reject","readFile","err","data","message","setDebugLogger","globalDebugMode","testcases","allWebGPUTestcases","webgpuQuery","loader","map","Map","testcase","loadCases","name","query","toString","set","runTestcase","expectations","rec","res","record","run","server","createServer","request","response","url","end","runPrefix","terminatePrefix","substr","get","result","logs","join","status","statusCode","JSON","stringify","close","listen","address","port","catch","ex","error","stack"],"mappings":"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","sourcesContent":["/* eslint no-console: \"off\" */\n\nimport * as fs from 'fs';\nimport * as http from 'http';\nimport { AddressInfo } from 'net';\n\nimport { dataCache } from '../framework/data_cache.js';\nimport { DefaultTestFileLoader } from '../internal/file_loader.js';\nimport { prettyPrintLog } from '../internal/logging/log_message.js';\nimport { Logger } from '../internal/logging/logger.js';\nimport { LiveTestCaseResult } from '../internal/logging/result.js';\nimport { parseQuery } from '../internal/query/parseQuery.js';\nimport { TestQueryWithExpectation } from '../internal/query/query.js';\nimport { TestTreeLeaf } from '../internal/tree.js';\nimport { Colors } from '../util/colors.js';\nimport { setGPUProvider } from '../util/navigator_gpu.js';\n\nimport sys from './helper/sys.js';\n\nfunction usage(rc: number): never {\n  console.log('Usage:');\n  console.log(`  tools/run_${sys.type} [OPTIONS...]`);\n  console.log('Options:');\n  console.log('  --colors             Enable ANSI colors in output.');\n  console.log('  --data               Path to the data cache directory.');\n  console.log('  --verbose            Print result/log of every test as it runs.');\n  console.log('  --gpu-provider       Path to node module that provides the GPU implementation.');\n  console.log('  --gpu-provider-flag  Flag to set on the gpu-provider as <flag>=<value>');\n  console.log(``);\n  console.log(`Provides an HTTP server used for running tests via an HTTP RPC interface`);\n  console.log(`To run a test, perform an HTTP GET or POST at the URL:`);\n  console.log(`  http://localhost:port/run?<test-name>`);\n  console.log(`To shutdown the server perform an HTTP GET or POST at the URL:`);\n  console.log(`  http://localhost:port/terminate`);\n  return sys.exit(rc);\n}\n\ninterface RunResult {\n  status: string;\n  message: string;\n}\n\ninterface GPUProviderModule {\n  create(flags: string[]): GPU;\n}\n\nif (!sys.existsSync('src/common/runtime/cmdline.ts')) {\n  console.log('Must be run from repository root');\n  usage(1);\n}\n\nColors.enabled = false;\n\nlet verbose = false;\nlet gpuProviderModule: GPUProviderModule | undefined = undefined;\nlet dataPath: string | undefined = undefined;\n\nconst gpuProviderFlags: string[] = [];\nfor (let i = 0; i < sys.args.length; ++i) {\n  const a = sys.args[i];\n  if (a.startsWith('-')) {\n    if (a === '--colors') {\n      Colors.enabled = true;\n    } else if (a === '--data') {\n      dataPath = sys.args[++i];\n    } else if (a === '--gpu-provider') {\n      const modulePath = sys.args[++i];\n      gpuProviderModule = require(modulePath);\n    } else if (a === '--gpu-provider-flag') {\n      gpuProviderFlags.push(sys.args[++i]);\n    } else if (a === '--help') {\n      usage(1);\n    } else if (a === '--verbose') {\n      verbose = true;\n    } else {\n      console.log(`unrecognised flag: ${a}`);\n    }\n  }\n}\n\nif (gpuProviderModule) {\n  setGPUProvider(() => gpuProviderModule!.create(gpuProviderFlags));\n}\n\nif (dataPath !== undefined) {\n  dataCache.setStore({\n    load: (path: string) => {\n      return new Promise<string>((resolve, reject) => {\n        fs.readFile(`${dataPath}/${path}`, 'utf8', (err, data) => {\n          if (err !== null) {\n            reject(err.message);\n          } else {\n            resolve(data);\n          }\n        });\n      });\n    },\n  });\n}\nif (verbose) {\n  dataCache.setDebugLogger(console.log);\n}\n\n(async () => {\n  Logger.globalDebugMode = verbose;\n  const log = new Logger();\n  const testcases = allWebGPUTestcases();\n\n  async function allWebGPUTestcases() {\n    const webgpuQuery = parseQuery('webgpu:*');\n    const loader = new DefaultTestFileLoader();\n    const map = new Map<string, TestTreeLeaf>();\n    for (const testcase of await loader.loadCases(webgpuQuery)) {\n      const name = testcase.query.toString();\n      map.set(name, testcase);\n    }\n    return map;\n  }\n\n  async function runTestcase(\n    testcase: TestTreeLeaf,\n    expectations: TestQueryWithExpectation[] = []\n  ): Promise<LiveTestCaseResult> {\n    const name = testcase.query.toString();\n    const [rec, res] = log.record(name);\n    await testcase.run(rec, expectations);\n    return res;\n  }\n\n  const server = http.createServer(\n    async (request: http.IncomingMessage, response: http.ServerResponse) => {\n      if (request.url === undefined) {\n        response.end('invalid url');\n        return;\n      }\n\n      const runPrefix = '/run?';\n      const terminatePrefix = '/terminate';\n\n      if (request.url.startsWith(runPrefix)) {\n        const name = request.url.substr(runPrefix.length);\n        try {\n          const testcase = (await testcases).get(name);\n          if (testcase) {\n            const result = await runTestcase(testcase);\n            let message = '';\n            if (result.logs !== undefined) {\n              message = result.logs.map(log => prettyPrintLog(log)).join('\\n');\n            }\n            const status = result.status;\n            const res: RunResult = { status, message };\n            response.statusCode = 200;\n            response.end(JSON.stringify(res));\n          } else {\n            response.statusCode = 404;\n            response.end(`test case '${name}' not found`);\n          }\n        } catch (err) {\n          response.statusCode = 500;\n          response.end(`run failed with error: ${err}`);\n        }\n      } else if (request.url.startsWith(terminatePrefix)) {\n        server.close();\n        sys.exit(1);\n      } else {\n        response.statusCode = 404;\n        response.end('unhandled url request');\n      }\n    }\n  );\n\n  server.listen(0, () => {\n    const address = server.address() as AddressInfo;\n    console.log(`Server listening at [[${address.port}]]`);\n  });\n})().catch(ex => {\n  console.error(ex.stack ?? ex.toString());\n  sys.exit(1);\n});\n"],"file":"server.js"}