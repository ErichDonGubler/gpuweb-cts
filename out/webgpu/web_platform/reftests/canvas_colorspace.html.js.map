{"version":3,"file":"canvas_colorspace.html.js","names":["kUnitCaseParamsBuilder","Float16Array","kCanvasAlphaModes","kCanvasColorSpaces","runRefTest","bgra8UnormFromRgba8Unorm","rgba8Unorm","bgra8Unorm","slice","i","length","rgba16floatFromRgba8unorm","rgba16Float","runColorSpaceTest","format","t","device","kRGBA8UnormData","Uint8Array","kBGRA8UnormData","kRGBA16FloatData","width","testData","rgba8unorm","bgra8unorm","rgba16float","createCanvas","alphaMode","colorSpace","canvas","document","createElement","height","context","getContext","configure","usage","GPUTextureUsage","COPY_DST","RENDER_ATTACHMENT","textureData","texture","getCurrentTexture","queue","writeTexture","buffer","bytesPerRow","byteLength","body","appendChild","u","combine"],"sources":["../../../../src/webgpu/web_platform/reftests/canvas_colorspace.html.ts"],"sourcesContent":["import { kUnitCaseParamsBuilder } from '../../../common/framework/params_builder.js';\nimport { Float16Array } from '../../../external/petamoriken/float16/float16.js';\nimport { kCanvasAlphaModes, kCanvasColorSpaces } from '../../capability_info.js';\n\nimport { runRefTest } from './gpu_ref_test.js';\n\nfunction bgra8UnormFromRgba8Unorm(rgba8Unorm: Uint8Array) {\n  const bgra8Unorm = rgba8Unorm.slice();\n  for (let i = 0; i < bgra8Unorm.length; i += 4) {\n    [bgra8Unorm[i], bgra8Unorm[i + 2]] = [bgra8Unorm[i + 2], bgra8Unorm[i]];\n  }\n  return bgra8Unorm;\n}\n\nfunction rgba16floatFromRgba8unorm(rgba8Unorm: Uint8Array) {\n  const rgba16Float = new Float16Array(rgba8Unorm.length);\n  for (let i = 0; i < rgba8Unorm.length; ++i) {\n    rgba16Float[i] = rgba8Unorm[i] / 255;\n  }\n  return rgba16Float;\n}\n\nexport function runColorSpaceTest(format: GPUTextureFormat) {\n  runRefTest(t => {\n    const device = t.device;\n\n    // prettier-ignore\n    const kRGBA8UnormData = new Uint8Array([\n      0, 255, 0, 255,\n      117, 251, 7, 255,\n      170, 35, 209, 255,\n      80, 150, 200, 255,\n    ]);\n    const kBGRA8UnormData = bgra8UnormFromRgba8Unorm(kRGBA8UnormData);\n    const kRGBA16FloatData = rgba16floatFromRgba8unorm(kRGBA8UnormData);\n    const width = kRGBA8UnormData.length / 4;\n\n    const testData: { [id: string]: Uint8Array | Float16Array } = {\n      rgba8unorm: kRGBA8UnormData,\n      bgra8unorm: kBGRA8UnormData,\n      rgba16float: kRGBA16FloatData,\n    };\n\n    function createCanvas(\n      alphaMode: GPUCanvasAlphaMode,\n      format: GPUTextureFormat,\n      colorSpace: PredefinedColorSpace\n    ) {\n      const canvas = document.createElement('canvas');\n      canvas.width = width;\n      canvas.height = 1;\n      const context = canvas.getContext('webgpu') as GPUCanvasContext;\n      context.configure({\n        device,\n        format,\n        usage: GPUTextureUsage.COPY_DST | GPUTextureUsage.RENDER_ATTACHMENT,\n        alphaMode,\n        colorSpace,\n      });\n\n      const textureData = testData[format];\n      const texture = context.getCurrentTexture();\n      device.queue.writeTexture(\n        { texture },\n        textureData.buffer,\n        {\n          bytesPerRow: textureData.byteLength,\n        },\n        { width: 4, height: 1 }\n      );\n      document.body.appendChild(canvas);\n    }\n\n    const u = kUnitCaseParamsBuilder\n      .combine('alphaMode', kCanvasAlphaModes)\n      .combine('colorSpace', kCanvasColorSpaces);\n\n    for (const { alphaMode, colorSpace } of u) {\n      createCanvas(alphaMode, format, colorSpace);\n    }\n  });\n}\n"],"mappings":"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"}